<!--
/*
 * Copyright 2013 The Polymer Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<link rel="import" href="../components/core-layout/core-layout.html">
<link rel="import" href="../components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../components/core-header-panel/core-header-panel.html">
<link rel="import" href="../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../components/core-menu/core-menu.html">
<link rel="import" href="../components/core-item/core-item.html">
<link rel="import" href="../components/core-pages/core-pages.html">
<link rel="import" href="../components/core-icon-button/core-icon-button.html">
<link rel="import" href="pi-toolbar-buttons.html">
<link rel="import" href="pi-feed-viewer.html">
<link rel="import" href="pi-explore.html">
<link rel="import" href="pi-home.html">
<link rel="import" href="pi-accounts.html">
<link rel="import" href="pi-accounts-model.html">

<polymer-element name="pi-app" on-keyup="{{keyupHandler}}">
  <template>
    <link rel="stylesheet" href="css/pi-app.css">
    <link rel="stylesheet" href="../components/core-layout/core-layout.css">
    
    <core-drawer-panel id="panels">
      
      <core-header-panel drawer id="appDrawer" mode="waterfall">
        
        <core-toolbar id="appPlate" class="medium-tall">Pica</core-toolbar>

        <core-menu selected="{{selectedView}}" valueattr="label" on-core-activate="{{toggleDrawer}}">
          <core-item label="Home" src="../images/ribbon_home_lightreg.png"></core-item>
          <core-item label="Topics" src="../images/ribbon_topics_lightreg.png"></core-item>
          <core-item label="Explore" src="../images/ribbon_explore_lightreg.png"></core-item>
          <core-item label="Accounts" src="../images/ribbon_accounts_lightreg.png"></core-item>
        </core-menu>

      </core-header-panel>

      <div main mode="waterfall" class="core-v core-fit">

        <core-toolbar id="appToolbar" class="medium-tall">
          
          <core-icon-button icon="{{nav}}" on-tap="{{navAction}}"></core-icon-button>
          <div core-flex class="toolbar-label">{{toolbarLabel}}</div>
          <core-toolbar id="actionbar" hidden?="{{hideActionbar}}" responsive>
            <pi-link-button id="linkButton" link="{{story.link}}" hidden?="{{hideLinkButton}}"></pi-link-button>
            <pi-view-button id="viewButton" layout="{{selectedLayout}}" halign="right" hidden?="{{hideViewButton}}"></pi-view-button>
            <pi-action-button halign="right"></pi-action-button>
            <core-icon-button icon="refresh" on-tap="{{reloadAction}}"></core-icon-button>
          </core-toolbar>

        </core-toolbar>

        <core-pages class="core-flex" id="contentPanels" selected="{{selectedView}}" valueattr="id" 
            on-core-select="{{panelSelectAction}}">
          
          <div id="Home"><template if="{{activatedPanels.Home}}">
              <pi-home stocks="{{$.accountsModel.stocks}}"></pi-home>
          </template></div>
          <pi-feed-viewer id="Topics" topics="{{$.accountsModel.topics}}" panel="{{selectedViewPanel}}"
              layout="{{layout}}" topicsLayout="grid" story="{{story}}"></pi-feed-viewer>
          <div id="Explore"><template if="{{activatedPanels.Explore}}">
            <pi-explore isContentPanel panel="{{selectedViewPanel}}"></pi-explore>
          </template></div>
          <div id="Accounts"><template if="{{activatedPanels.Accounts}}">
              <pi-accounts accounts="{{$.accountsModel}}"></pi-accounts>
          </template></div>

        </core-pages>
      </div>

    </core-drawer-panel>
    
    <pi-accounts-model id="accountsModel"></pi-accounts-model>
  </template>
  <script>
    (function() {
      var ESCAPE_KEY = 27;
      
      Polymer('pi-app', {
        selectedView: 'Topics',
        menuActive: false,
        selectedViewPanel: '',
        selectedLayout: null,
        ready: function() {
          this.activatedPanels = {};
          // listen for screen size change
          var mq = window.matchMedia('(max-width: 800px)');
          mq.addListener(this.screenSizeChange.bind(this));
          this.screenSizeChange(mq);
          // initialization
          this.selectedLayout = this.layout;
          this.selectedViewPanel = 'topics';
        },
        enteredView: function() {
          this.super();
        },
        screenSizeChange: function(query) {
          if (query.matches && this.selectedLayout === 'quilt') {
            // use stream layout if user select quilt and screen size is small
            this.layout = 'stream';
          } else {
            this.layout = this.selectedLayout ||
                (query.matches ? 'stream' : 'quilt');
          }
        },
        selectedLayoutChanged: function() {
          this.layout = this.selectedLayout;
        },
        getSelectedContentPanel: function() {
          var p = this.$.contentPanels.selectedItem;
          return p && p.querySelector('[isContentPanel]') || p;
        },
        navAction: function() {
          var p = this.getSelectedContentPanel();
          if (!(p.previous && p.previous())) {
            this.toggleDrawer();
          }
        },
        toggleDrawer: function() {
          this.$.panels.togglePanel();
        },
        reloadAction: function() {
          var p = this.getSelectedContentPanel();
          p.reload && p.reload();
        },
        selectedViewChanged: function() {
          this.updateToolbar();
        },
        selectedViewPanelChanged: function() {
          this.updateToolbar();
        },
        updateToolbar: function() {
          var p = this.getSelectedContentPanel();
          this.toolbarLabel = p && p.canPrevious && p.topic ?
              p.topic.title : this.selectedView;
          this.nav = p && p.canPrevious ? 'left' : 'menu';
          this.hideActionbar = this.selectedView !== 'Topics';
          this.hideViewButton = this.selectedViewPanel !== 'stories';
          this.hideLinkButton = this.selectedViewPanel !== 'story';
        },
        keyupHandler: function(e) {
          if (e.keyCode === ESCAPE_KEY) {
            this.navAction();
          }
        },
        // instantiate lazy content
        panelSelectAction: function(e) {
          if (e.target.selected) {
            this.activatedPanels[e.target.selected] = true;
          }
        },
        accountsReadyHandler: function(e) {
          this.$.Accounts.classList.add('ready');
        },
        homeReadyHandler: function(e) {
          this.$.Home.classList.add('ready');
        }
      });
    })();
  </script>
</polymer-element>
